name: VPS_github

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

env:
  GITHUB_TOKEN_VPS: ${{ secrets.GH_TOKEN }}
  MY_PASSWORD: ${{ secrets.MY_PASSWORD }}

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: â¬‡ï¸ Checkout source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: ğŸ–¥ï¸ CÃ i Ä‘áº·t vÃ  cháº¡y RDP + Cloudflared (Quick Tunnel)
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Enabling RDP and installing Cloudflared..."
    
        # Báº­t Remote Desktop
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… Remote Desktop enabled and firewall opened"
    
        # Äáº·t password cho user hiá»‡n táº¡i (náº¿u cáº§n)
        $password = "${{ secrets.MY_PASSWORD }}"
        net user $env:USERNAME $password
        Write-Host "ğŸ” Password set for user $env:USERNAME"
    
        # CÃ i Cloudflared
        Write-Host "ğŸ“¥ Installing Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe" -TimeoutSec 60
        Unblock-File -Path "cloudflared.exe"
        Write-Host "âœ… Cloudflared downloaded"
    
        # Cháº¡y Cloudflared quick tunnel cho RDP
        Write-Host "ğŸŒ Starting Cloudflared tunnel for RDP..."
        $logFile = "cloudflared.log"
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel","--url","rdp://localhost:3389","--no-autoupdate" -RedirectStandardOutput $logFile -RedirectStandardError $logFile -WindowStyle Hidden
        Start-Sleep -Seconds 25
    
        # Parse URL tá»« log
        Write-Host "ğŸ” Searching for public RDP URL..."
        $maxAttempts = 180
        $attempt = 0
        $cloudflaredUrl = ""
        do {
          Start-Sleep -Seconds 2
          $attempt++
          if (Test-Path $logFile) {
            $log = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
            if ($log -match "tcp://[a-zA-Z0-9\-\.]+\.trycloudflare\.com:[0-9]+") {
              $cloudflaredUrl = $matches[0]
              break
            }
          }
        } while (-not $cloudflaredUrl -and $attempt -lt $maxAttempts)
    
        if ($cloudflaredUrl) {
          Write-Host "âœ… Found Cloudflared RDP URL: $cloudflaredUrl"
    
          $rdpContent = @"
    full address:s:$cloudflaredUrl
    username:s:$env:USERNAME
    prompt for credentials:i:1
    "@
          $rdpContent | Out-File -FilePath "rdp-connection.rdp" -Encoding ASCII
    
          Write-Host "ğŸ’¾ Saved RDP file as rdp-connection.rdp"
          Write-Host "ğŸŒ Connect with Microsoft Remote Desktop (mstsc.exe)"
          Write-Host "   ğŸ‘‰ Address: $cloudflaredUrl"
          Write-Host "   ğŸ‘‰ Username: $env:USERNAME"
          Write-Host "   ğŸ‘‰ Password: (the one from secrets.MY_PASSWORD)"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add rdp-connection.rdp
          git commit -m "ğŸ”— rdp file - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --allow-empty
          git push origin main
          Write-Host "âœ… RDP file committed and pushed"
        }
        else {
          Write-Host "âŒ Failed to retrieve Cloudflared URL"
          Get-Content $logFile -Tail 50 | Write-Host
          exit 1
        }

    - name: ğŸ–¥ï¸ Cháº¡y VPS
      shell: pwsh
      run: |
        Write-Host "ğŸš€ VPS Session Started - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

        $totalMinutes = 330
        $restartCheckpoint = 320
        $healthCheckInterval = 15
        $backupInterval = 60

        for ($i = 1; $i -le $totalMinutes; $i++) {
          $currentTime = Get-Date -Format 'HH:mm:ss'
          Write-Host "ğŸŸ¢ VPS Running - Minute $i/$totalMinutes ($currentTime)"

          if ($i -eq $restartCheckpoint) {
            Write-Host "ğŸ” Preparing restart in $($totalMinutes - $i) minutes..."
          }

          # (TÃ¹y chá»n) CÃ³ thá»ƒ thÃªm logic healthcheck hoáº·c backup á»Ÿ Ä‘Ã¢y
          Start-Sleep -Seconds 60
        }

        Write-Host "â° VPS session completed. Preparing restart..."